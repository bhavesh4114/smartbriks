// SmartBrik - Real Estate Fractional Investment Platform
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================
// ENUMS
// =====================================

enum UserRole {
  ADMIN
  BUILDER
  INVESTOR
}

enum KycStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum ProjectStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  ACTIVE
  FUNDED
  COMPLETED
}

enum InvestmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

// =====================================
// MODELS
// =====================================

model User {
  id           Int       @id @default(autoincrement())
  fullName     String    @map("full_name")
  email        String    @unique
  mobileNumber String    @unique @map("mobile_number")
  password     String
  role         UserRole  @default(INVESTOR)
  kycStatus    KycStatus @default(PENDING) @map("kyc_status")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  investments Investment[]
  payments    Payment[]
  kyc         KYC[]
  userReturns UserReturn[]

  @@map("users")
}

model Builder {
  id            Int       @id @default(autoincrement())
  companyName   String    @map("company_name")
  contactPerson String    @map("contact_person")
  email         String    @unique
  mobileNumber  String    @unique @map("mobile_number")
  password      String
  role          UserRole  @default(BUILDER)
  kycStatus     KycStatus @default(PENDING) @map("kyc_status")
  isApproved    Boolean   @default(false) @map("is_approved")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  projects Project[]
  kyc      KYC[]
  payments Payment[]

  @@map("builders")
}

model Project {
  id                    Int           @id @default(autoincrement())
  title                 String
  description           String
  location              String
  totalValue            Decimal       @map("total_value") // â‚¹
  totalShares           Int           @map("total_shares")
  pricePerShare         Decimal       @map("price_per_share")
  minInvestment         Decimal       @map("min_investment")
  expectedROI           Decimal       @map("expected_roi") // %
  projectStatus         ProjectStatus @default(DRAFT) @map("project_status")
  builderId             Int           @map("builder_id")
  projectDurationMonths Int?          @map("project_duration_months")
  keyFeatures           String?       @map("key_features")
  approvedAt            DateTime?     @map("approved_at")
  rejectionReason       String?       @map("rejection_reason")
  startDate             DateTime?     @map("start_date")
  endDate               DateTime?     @map("end_date")
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  builder     Builder              @relation(fields: [builderId], references: [id], onDelete: Cascade)
  investments Investment[]
  returns     ReturnDistribution[]
  payments    Payment[]
  images      ProjectImage[]

  @@index([builderId])
  @@index([projectStatus])
  @@map("projects")
}

model ProjectImage {
  id        Int      @id @default(autoincrement())
  projectId Int      @map("project_id")
  imageUrl  String   @map("image_url")
  createdAt DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("project_images")
}

model Investment {
  id               Int              @id @default(autoincrement())
  userId           Int              @map("user_id")
  projectId        Int              @map("project_id")
  investedAmount   Decimal          @map("invested_amount")
  sharesPurchased  Int              @map("shares_purchased")
  investmentStatus InvestmentStatus @default(ACTIVE) @map("investment_status")
  createdAt        DateTime         @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
  @@map("investments")
}

model Payment {
  id              Int           @id @default(autoincrement())
  userId          Int?          @map("user_id")
  builderId       Int?          @map("builder_id")
  projectId       Int           @map("project_id")
  amount          Decimal
  paymentStatus   PaymentStatus @default(PENDING) @map("payment_status")
  paymentMethod   String        @map("payment_method")
  transactionId   String?       @map("transaction_id")
  gatewayResponse Json?         @map("gateway_response")
  createdAt       DateTime      @default(now()) @map("created_at")

  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  builder Builder? @relation(fields: [builderId], references: [id], onDelete: SetNull)
  project Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([builderId])
  @@index([projectId])
  @@index([transactionId])
  @@map("payments")
}

model ReturnDistribution {
  id               Int      @id @default(autoincrement())
  projectId        Int      @map("project_id")
  totalProfit      Decimal  @map("total_profit")
  distributionDate DateTime @default(now()) @map("distribution_date")

  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userReturns UserReturn[]

  @@index([projectId])
  @@map("return_distributions")
}

model UserReturn {
  id                   Int      @id @default(autoincrement())
  returnDistributionId Int      @map("return_distribution_id")
  userId               Int      @map("user_id")
  amount               Decimal
  creditedAt           DateTime @default(now()) @map("credited_at")

  returnDistribution ReturnDistribution @relation(fields: [returnDistributionId], references: [id], onDelete: Cascade)
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([returnDistributionId])
  @@index([userId])
  @@map("user_returns")
}

model KYC {
  id              Int       @id @default(autoincrement())
  userId          Int?      @map("user_id")
  builderId       Int?      @map("builder_id")
  documentType    String    @map("document_type")
  documentNumber  String    @map("document_number")
  documentImage   String?   @map("document_image")
  rejectionReason String?   @map("rejection_reason")
  status          KycStatus @default(PENDING)
  verifiedAt      DateTime? @map("verified_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  user    User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  builder Builder? @relation(fields: [builderId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([builderId])
  @@map("kyc")
}
